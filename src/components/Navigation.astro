---
import LinkedInIcon from './icons/LinkedInIcon.astro';
import logo from '../images/logo.png';

interface Props {
  compact?: boolean;
}

const { compact = false } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;
---

<header class={`site-header ${compact ? '' : 'at-top'}`} data-compact={compact}>
  <nav class="nav-pill" aria-label="Main navigation">
    <div class="nav-left">
      <a href={baseUrl} class="branding" aria-label="Home">
        <div class="logo-container">
          <img src={logo.src} alt="Logo" class="logo-img" />
        </div>
        <div class="branding-text">
          <span class="branding-name">Design Doings</span>
          <span class="branding-subtitle">by Xiaoxue Dong</span>
        </div>
      </a>
    </div>

    <div class="nav-right">
      <div class="nav-links">
        <a href={`${baseUrl}#projects`} class="nav-link">Work</a>
        <a href={`${baseUrl}about`} class="nav-link">About</a>
      </div>

      <button class="theme-toggle" aria-label="Toggle theme" onclick="window.toggleTheme()">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
      </button>

      <a href="https://www.linkedin.com/in/xiaoxued/" target="_blank" rel="noopener" class="cta-button">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"/>
        </svg>
        LinkedIn
      </a>
    </div>

    <button class="hamburger" aria-label="Menu" aria-expanded="false">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </nav>

  <div class="mobile-menu">
    <div class="mobile-menu-content">
      <a href={`${baseUrl}#projects`} class="mobile-nav-link">Work</a>
      <a href={`${baseUrl}about`} class="mobile-nav-link">About</a>
      <button class="mobile-theme-toggle" aria-label="Toggle theme" onclick="window.toggleTheme()">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <span class="theme-toggle-text">Toggle theme</span>
      </button>
      <a href="https://www.linkedin.com/in/xiaoxued/" target="_blank" rel="noopener" class="mobile-cta-button">
        <LinkedInIcon width={16} height={16} />
        LinkedIn
      </a>
    </div>
  </div>
</header>

<style>
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    display: flex;
    justify-content: center;
    padding: 1.5rem;
  }

  .nav-pill {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--gap-xl);
    padding: 0.75rem 1rem;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(var(--blur-glass));
    -webkit-backdrop-filter: blur(var(--blur-glass));
    border: 1px solid var(--color-border-alpha);
    border-radius: var(--radius-pill);
    box-shadow: rgba(0, 0, 0, 0.07) 0px 3.5px 10px 0px,
                rgba(0, 0, 0, 0.035) 0px 28px 80px 0px;
    transition: box-shadow 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                border-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    max-width: var(--max-width);
    transform-origin: top center;
    z-index: 1001;
  }

  :global([data-theme="dark"]) .nav-pill {
    background: rgba(26, 15, 46, 0.8);
    border-color: rgba(61, 45, 95, 0.6);
    box-shadow: rgba(255, 255, 255, 0.1) 0px 3.5px 10px 0px,
                rgba(255, 255, 255, 0.05) 0px 28px 80px 0px;
  }

  .site-header.at-top .nav-pill {
    border-color: transparent;
    box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px 0px,
                rgba(0, 0, 0, 0) 0px 0px 0px 0px;
  }

  .nav-left {
    display: flex;
    align-items: center;
    transform-origin: top center;
  }

  .branding {
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
    transition: opacity var(--transition-normal);
  }

  .branding:hover {
    opacity: var(--opacity-strong);
  }

  .avatar-placeholder {
    width: var(--icon-xl);
    height: var(--icon-xl);
    border-radius: var(--radius-full);
    background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
  }

  .avatar-placeholder svg {
    width: var(--icon-md);
    height: var(--icon-md);
  }

  .logo-container {
    width: var(--icon-xl);
    height: var(--icon-xl);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
  }

  .logo-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .branding-text {
    display: flex;
    flex-direction: column;
    gap: var(--gap-tight);
  }

  .branding-name {
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    line-height: var(--line-height-tight);
    transition: color var(--transition-normal);
  }

  .branding-subtitle {
    font-size: var(--font-size-ui-sm);
    font-weight: var(--font-weight-regular);
    color: var(--color-text-light);
    line-height: var(--line-height-tight);
    transition: color var(--transition-normal);
  }

  .nav-right {
    display: flex;
    align-items: center;
    gap: var(--gap-lg);
    transform-origin: top center;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: var(--gap-lg);
  }

  .nav-link {
    font-size: var(--font-size-body-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    transition: color 0.2s ease;
    padding: 0.5rem 0;
  }

  .nav-link:hover {
    color: var(--color-primary);
  }

  .cta-button {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    padding: 0.625rem 1.25rem;
    background: linear-gradient(180deg, rgb(37, 88, 235) 0%, rgb(59, 107, 246) 100%);
    color: white;
    font-size: var(--font-size-body-sm);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-pill);
    border: 1px solid rgb(37, 88, 235);
    box-shadow: rgba(0, 0, 0, 0.17) 0px 0.27px 0.47px 0px,
                rgba(0, 0, 0, 0.1) 0px 0.89px 1.56px 0px,
                rgba(0, 0, 0, 0.07) 0px 4px 7px 0px;
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  }

  .cta-button:hover {
    transform: translateY(-1px);
    box-shadow: rgba(0, 0, 0, 0.2) 0px 0.27px 0.47px 0px,
                rgba(0, 0, 0, 0.15) 0px 0.89px 1.56px 0px,
                rgba(0, 0, 0, 0.1) 0px 6px 10px 0px;
  }

  .cta-button:active {
    transform: translateY(0);
  }

  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-full);
    background: transparent;
    border: 1px solid var(--color-border-alpha);
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
  }

  .theme-toggle:hover {
    background: var(--color-hover-bg);
    border-color: rgba(228, 228, 231, 1);
  }

  .theme-toggle svg {
    position: absolute;
    transition: all var(--transition-normal);
  }

  .sun-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  .moon-icon {
    opacity: 0;
    transform: rotate(90deg) scale(0);
  }

  :global([data-theme="dark"]) .sun-icon {
    opacity: 0;
    transform: rotate(-90deg) scale(0);
  }

  :global([data-theme="dark"]) .moon-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
    color: white;
  }

  .hamburger {
    display: none;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    margin: -8px;
  }

  .hamburger span {
    width: 20px;
    height: 2px;
    background: var(--color-text);
    border-radius: var(--radius-xs);
    transition: all var(--transition-normal);
  }

  .hamburger[aria-expanded="true"] span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .hamburger[aria-expanded="true"] span:nth-child(2) {
    opacity: 0;
    transform: scaleX(0);
  }

  .hamburger[aria-expanded="true"] span:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
  }

  .mobile-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 3rem);
    max-width: 400px;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(var(--blur-glass));
    -webkit-backdrop-filter: blur(var(--blur-glass));
    border: 1px solid var(--color-border-alpha);
    border-radius: var(--radius-3xl);
    box-shadow: rgba(0, 0, 0, 0.07) 0px 3.5px 10px 0px,
                rgba(0, 0, 0, 0.035) 0px 28px 80px 0px;
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-normal), visibility var(--transition-normal), transform var(--transition-normal);
    transform: translateX(-50%) translateY(-10px);
  }

  :global([data-theme="dark"]) .mobile-menu {
    background: rgba(26, 15, 46, 0.8);
    border-color: rgba(61, 45, 95, 0.6);
    box-shadow: rgba(255, 255, 255, 0.1) 0px 3.5px 10px 0px,
                rgba(255, 255, 255, 0.05) 0px 28px 80px 0px;
  }

  .mobile-menu.open {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .mobile-menu-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm);
  }

  .mobile-nav-link {
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    padding: 0.875rem 1rem;
    border-radius: var(--radius-lg);
    transition: background-color var(--transition-fast);
  }

  .mobile-nav-link:hover {
    background-color: var(--color-hover-bg);
  }

  .mobile-cta-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--gap-xs);
    padding: 0.875rem 1rem;
    background: var(--color-primary);
    color: white;
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-medium);
    border-radius: var(--radius-lg);
    margin-top: var(--spacing-xs);
    transition: all var(--transition-fast);
  }

  .mobile-cta-button:hover {
    background: var(--color-secondary);
  }

  .mobile-theme-toggle {
    display: flex;
    align-items: center;
    gap: var(--gap-sm);
    padding: 0.875rem 1rem;
    background: transparent;
    border: 1px solid var(--color-border-alpha);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--font-size-body);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    position: relative;
  }

  .mobile-theme-toggle:hover {
    background: var(--color-hover-bg);
  }

  .mobile-theme-toggle svg {
    transition: all var(--transition-normal);
    flex-shrink: 0;
  }

  .mobile-theme-toggle .sun-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  .mobile-theme-toggle .moon-icon {
    opacity: 0;
    transform: rotate(90deg) scale(0);
    position: absolute;
    left: 0.875rem;
  }

  :global([data-theme="dark"]) .mobile-theme-toggle .sun-icon {
    opacity: 0;
    transform: rotate(-90deg) scale(0);
    position: absolute;
    left: 0.875rem;
  }

  :global([data-theme="dark"]) .mobile-theme-toggle .moon-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
    position: static;
    color: white;
  }

  @media (max-width: 768px) {
    .site-header {
      padding: 1rem;
    }

    .nav-pill {
      padding: 0.625rem 1rem;
      gap: var(--gap-md);
      width: 100%;
    }

    .avatar-placeholder {
      width: 36px;
      height: 36px;
    }

    .avatar-placeholder svg {
      width: 20px;
      height: 20px;
    }

    .logo-container {
      width: 36px;
      height: 36px;
    }

    .nav-right {
      display: none;
    }

    .hamburger {
      display: flex;
    }
  }

  @media (min-width: 769px) {
    .mobile-menu {
      display: none;
    }
  }
</style>

<script>
  // Scroll behavior
  const header = document.querySelector('.site-header') as HTMLElement | null;
  const navPill = document.querySelector('.nav-pill') as HTMLElement | null;
  const navLeft = document.querySelector('.nav-left') as HTMLElement | null;
  const navRight = document.querySelector('.nav-right') as HTMLElement | null;
  // Check for attribute presence - Astro boolean attributes render as empty string when true
  const isCompact = header?.hasAttribute('data-compact');

  function updateHeaderOnScroll() {
    const currentScroll = window.pageYOffset;

    // Skip all scroll behavior if in compact mode
    if (isCompact) {
      header?.classList.remove('at-top');
      if (navPill) navPill.style.transform = 'scaleY(1)';
      if (navLeft) navLeft.style.transform = 'scaleY(1)';
      if (navRight) navRight.style.transform = 'scaleY(1)';
      return;
    }

    if (currentScroll <= 50) {
      header?.classList.add('at-top');
    } else {
      header?.classList.remove('at-top');
    }

    // Simple scale-in effect on scroll (Y-axis only)
    if (navPill) {
      const scrollProgress = Math.min(currentScroll / 200, 1); // 0 to 1 over first 200px
      const scale = 1.3 - (0.3 * scrollProgress); // 1.3 to 1.0
      navPill.style.transform = `scaleY(${scale})`;

      // Counter-scale the content to keep it normal size
      const counterScale = 1 / scale;
      if (navLeft) navLeft.style.transform = `scaleY(${counterScale})`;
      if (navRight) navRight.style.transform = `scaleY(${counterScale})`;
    }
  }

  window.addEventListener('scroll', updateHeaderOnScroll);
  updateHeaderOnScroll();

  // Mobile menu toggle
  const hamburger = document.querySelector('.hamburger');
  const mobileMenu = document.querySelector('.mobile-menu');

  hamburger?.addEventListener('click', () => {
    const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
    hamburger.setAttribute('aria-expanded', (!isExpanded).toString());
    mobileMenu?.classList.toggle('open');
  });

  // Close mobile menu when clicking a link
  const mobileLinks = document.querySelectorAll('.mobile-nav-link, .mobile-cta-button');
  mobileLinks.forEach(link => {
    link.addEventListener('click', () => {
      hamburger?.setAttribute('aria-expanded', 'false');
      mobileMenu?.classList.remove('open');
    });
  });

  // Close mobile menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!header?.contains(e.target as Node)) {
      hamburger?.setAttribute('aria-expanded', 'false');
      mobileMenu?.classList.remove('open');
    }
  });
</script>
